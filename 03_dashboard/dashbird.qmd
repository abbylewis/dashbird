---
title: "DashBIRD"
title-block-banner: true
format: 
  html:
    page-layout: full
server: shiny
---

<style>
.quarto-title-banner {
  background-image: url("images/background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  
  /* Make it taller */
  min-height: 200px;
  
  color: white; 
}

.quarto-title-banner .title {
  margin-top: 100px; /* Adjust the value as needed */
}
.quarto-title-banner .subtitle, 
.quarto-title-banner .author {
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6); /* make text readable */
}

</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

library(tidyverse)
library(plotly)
library(shiny)

```

::: {.row}

::: {.column width="23%"}

```{r}
#| panel: sidebar

h4("Plot Specifications")
br()
radioButtons(inputId = "to_plot",
             label = "To plot:",
             choices = c("Species",
                         "Individuals",
                         "Checklists"))
br()
radioButtons(inputId = "contrib",
             label = "Show individual contributions?",
             choices = c("No",
                         "Yes"))
```

::: 

::: {.column width="73%"}

::: {.panel-tabset}

## Collaborative

```{r}
#| panel: fill
uiOutput('selected_comb', height = 420)
```

## Competitive

```{r}
#| panel: fill
uiOutput('selected_comp', height = 420)
```

## Venn

```{r}
#| panel: fill
plotOutput('venn', height = 420)
textOutput("abby")
```

:::

:::

:::

```{r}
#| context: server

everything <- read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Abby_allData.csv", show_col_types = F) %>%
  mutate(Observer = "Abby Lewis") %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Bjorn_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Bjorn Larson")) %>%
  mutate(Date = as.Date(Date, format = "%d %b %Y")) %>%
  arrange(Date) %>%
  mutate(check_ID = paste(Date, Time, Latitude, Longitude)) %>%
  filter(!grepl("sp.", `Common Name`))

#Species
all <- everything %>%
  select(`Common Name`, Date, Observer, Time) %>%
  mutate(year = year(Date),
         DateTime = as_datetime(paste(Date, Time))) %>%
  filter(!year == 2023) %>%
  arrange(DateTime) 

all_personal <- all %>%
  group_by(year, Observer) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number())

all_collaborative <- all %>%
  select(-Observer) %>%
  group_by(year) %>%
  filter(!duplicated(`Common Name`)) %>%
  left_join(all_personal) %>%
  group_by(DateTime, `Common Name`) %>%
  mutate(credit = 1/length(unique(Observer))) %>%
  group_by(Observer, year) %>%
  arrange(DateTime) %>%
  mutate(cum_sum = cumsum(credit)) %>%
  group_by(Observer) 

#Individuals
all_birds <- everything %>%
  group_by(check_ID) %>%
  filter(!Count == "X") %>%
  mutate(number_of_us = length(unique(Observer)),
         Count = as.numeric(Count)/number_of_us,
         Date = as.Date(Date, format = "%d %b %Y")) %>%
  ungroup() %>%
  arrange(Date) %>%
  select(Count, Date, Observer) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(as.numeric(Count))) %>%
  arrange(Date)

all_personal_birds <- all_birds %>%
  group_by(year, Observer) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_birds <- all_birds %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Checklists
all_check <- everything %>%
  select(check_ID, Observer, Date) %>%
  distinct() %>%
  group_by(check_ID) %>%
  mutate(number_of_us = length(unique(Observer)),
         Date = as.Date(Date, format = "%d %b %Y"),
         credit = 1/number_of_us) %>%
  arrange(Date) %>%
  select(check_ID, Date, Observer, credit) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(credit)) %>%
  arrange(Date)

all_personal_check <- all_check %>%
  group_by(year, Observer) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_check <- all_check %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Code for plots
output$plot_comb_split <- renderPlotly({
  comb_plot_data <- all_collaborative %>%
    mutate(yday = yday(Date)) %>%
    bind_rows(data.frame(yday = 365, 
                         year = c(2024, 2025, 2024, 2025),
                         Observer = c("Abby Lewis",
                                      "Abby Lewis",
                                      "Bjorn Larson",
                                      "Bjorn Larson"))) %>%
    group_by(Observer, year) %>%
    arrange(Observer, year, yday) %>%
    mutate(cum_sum = zoo::na.approx(cum_sum, rule = 2),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year),
           Date_stand = as.Date("2024-01-01")+days(yday-1)) 
  
  comb_plot <- comb_plot_data %>%
    ggplot(aes(x = Date_stand, y = cum_sum, fill = Observer))+
    geom_area()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_fill_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot, tooltip = c("fill"))
})

output$plot_comb <- renderPlotly({
  comb_plot <- all_collaborative %>%
    group_by(year) %>%
    mutate(cum_sum = cumsum(credit)) %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_bird <- renderPlotly({
  comb_plot <- all_collaborative_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_check <- renderPlotly({
  comb_plot <- all_collaborative_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp <- renderPlotly({
  comb_plot <- all_personal %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_bird <- renderPlotly({
  comb_plot <- all_personal_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_check <- renderPlotly({
  comb_plot <- all_personal_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$venn <- renderPlot({
  ggVennDiagram::ggVennDiagram(x = list(
    Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"]),
    Bjorn = unique(all_personal$`Common Name`[all_personal$Observer=="Bjorn Larson"])
  ),
  label_geom = "text",
  label_color="white",
  label_alpha = 0.9)
})

output$abby <- renderText({
  Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Abby Lewis"])
  Abby_text <- paste(Abby[!Abby%in%Other], collapse = "\n")
  Abby_text
})

#Choose what to plot
output$selected_comp <- renderUI({
  if (input$to_plot == "Species") {
    plotlyOutput("plot_comp")
  } else if (input$to_plot == "Individuals") {
    plotlyOutput("plot_comp_bird")
  } else if (input$to_plot == "Checklists") {
    plotlyOutput("plot_comp_check")
  }
})

output$selected_comb <- renderUI({
  if(input$to_plot == "Species") {
    if(input$contrib == "Yes") {
      plotlyOutput("plot_comb_split")
    }else{plotlyOutput("plot_comb")}
  }else if (input$to_plot == "Individuals") {
    plotlyOutput("plot_comb_bird")
  }else if (input$to_plot == "Checklists") {
    plotlyOutput("plot_comb_check")
  }
})
```
