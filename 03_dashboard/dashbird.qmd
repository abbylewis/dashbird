---
title: "DashBIRD"
title-block-banner: true
format: 
  html:
    page-layout: full
server: shiny
---

<style>
.quarto-title-banner {
  background-image: url("images/background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  
  /* Make it taller */
  min-height: 200px;
  
  color: white; 
}

.quarto-title-banner .title {
  margin-top: 100px; /* Adjust the value as needed */
}
.quarto-title-banner .subtitle, 
.quarto-title-banner .author {
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6); /* make text readable */
}

</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

library(tidyverse)
library(plotly)
library(shiny)

```

::: {.row}

::: {.column width="23%"}

```{r}
#| panel: sidebar

h4("Plot Specifications")
br()
radioButtons(inputId = "to_plot",
             label = "To plot:",
             choices = c("Species",
                         "Individuals",
                         "Checklists"))
br()
radioButtons(inputId = "contrib",
             label = "Show individual contributions?",
             choices = c("No",
                         "Yes"))
```

::: 

::: {.column width="73%"}

::: {.panel-tabset}

## Collaborative

```{r}
#| panel: fill
uiOutput('selected_comb', height = 420)
```

## Competitive

```{r}
#| panel: fill
uiOutput('selected_comp', height = 420)
```

## Venn

```{r}
#| panel: fill
plotOutput('venn', height = 420)
h3("Unique birds")
DT::dataTableOutput("unique_birds")
```

:::

:::

:::

```{r}
#| context: server

everything <- read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Abby_allData.csv", show_col_types = F) %>%
  mutate(Observer = "Abby Lewis") %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Bjorn_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Bjorn Larson"))  %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Eric_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Eric Larson"))  %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Sue_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Susan Lewis")) %>%
  mutate(Date = as.Date(Date, format = "%d %b %Y")) %>%
  arrange(Date) %>%
  mutate(check_ID = paste(Date, Time, Latitude, Longitude),
         `Common Name` = sub(" \\(.+\\)", "", `Common Name`)) %>%
  filter(!grepl("sp.", `Common Name`),
         !grepl("/", `Common Name`))

#Species
all <- everything %>%
  select(`Common Name`, Date, Observer, Time) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  arrange(Date) 

all_personal <- all %>%
  group_by(year, Observer) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number(),
         year = year(Date)) 

all_personal_filled <- all %>%
  group_by(year, Observer) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number()) %>%
  group_by(Date, Observer) %>%
  filter(cum_sum == max(cum_sum)) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    )) %>%
  mutate(year = year(Date)) %>%
  tibble() %>%
  group_by(Observer, year) %>%
  arrange(Date) %>%
  fill(c(cum_sum))

all_collaborative <- all %>%
  select(-Observer) %>%
  group_by(year) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number())  %>%
  left_join(all_personal %>% select(-cum_sum, -Time) %>%
              filter(!is.na(`Common Name`))) %>%
  group_by(Date, `Common Name`) %>%
  mutate(credit = 1/length(unique(Observer))) %>%
  group_by(Observer, year) %>%
  arrange(Date) %>%
  mutate(cum_sum = cumsum(credit)) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    )) %>%
  mutate(year = year(Date)) %>%
  arrange(Date) %>%
  fill(c(cum_sum)) %>%
  group_by(Observer) 

#Individuals
all_birds <- everything %>%
  group_by(check_ID) %>%
  filter(!Count == "X") %>%
  mutate(number_of_us = length(unique(Observer)),
         Count = as.numeric(Count)/number_of_us,
         Date = as.Date(Date, format = "%d %b %Y")) %>%
  ungroup() %>%
  arrange(Date) %>%
  select(Count, Date, Observer) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(as.numeric(Count))) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    ),
    fill = list(Count = 0)
  ) %>%
  mutate(year = year(Date)) %>%
  arrange(Date)

all_personal_birds <- all_birds %>%
  group_by(year, Observer) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_birds <- all_birds %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Checklists
all_check <- everything %>%
  select(check_ID, Observer, Date) %>%
  distinct() %>%
  group_by(check_ID) %>%
  mutate(number_of_us = length(unique(Observer)),
         Date = as.Date(Date, format = "%d %b %Y"),
         credit = 1/number_of_us) %>%
  arrange(Date) %>%
  select(check_ID, Date, Observer, credit) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(credit)) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    ),
    fill = list(Count = 0)
  ) %>%
  mutate(year = year(Date))

all_personal_check <- all_check %>%
  group_by(year, Observer) %>%
  arrange(year, Observer, Date) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_check <- all_check %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Code for plots
output$plot_comb_split <- renderPlotly({
  comb_plot_data <- all_collaborative %>%
    mutate(yday = yday(Date)) %>%
    group_by(Observer, year) %>%
    arrange(Observer, year, yday) %>%
    mutate(Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year),
           Date_stand = as.Date("2024-01-01")+days(yday-1)) 
  
  comb_plot <- comb_plot_data %>%
    ggplot(aes(x = Date_stand, y = cum_sum, fill = Observer))+
    geom_area()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_fill_manual(values = c("#60AB9A","#18476E","#F5B905","#A355C7"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot, tooltip = c("fill"))
})

output$plot_comb <- renderPlotly({
  comb_plot <- all_collaborative %>%
    group_by(Date, year) %>%
    summarize(credit = sum(credit, na.rm = T)) %>%
    group_by(year) %>%
    mutate(cum_sum = cumsum(credit)) %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_bird <- renderPlotly({
  comb_plot <- all_collaborative_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_check <- renderPlotly({
  comb_plot <- all_collaborative_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = c("#4ECDC4","#29363D","#E54B4B"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp <- renderPlotly({
  comb_plot <- all_personal_filled %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = c("#60AB9A","#18476E","#F5B905","#A355C7"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_bird <- renderPlotly({
  comb_plot <- all_personal_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = c("#60AB9A","#18476E","#F5B905","#A355C7"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_check <- renderPlotly({
  comb_plot <- all_personal_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = c("#60AB9A","#18476E","#F5B905","#A355C7"))+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$venn <- renderPlot({
  ggVennDiagram::ggVennDiagram(x = list(
    Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"]),
    Bjorn = unique(all_personal$`Common Name`[all_personal$Observer=="Bjorn Larson"]),
    Eric = unique(all_personal$`Common Name`[all_personal$Observer=="Eric Larson"]),
    Sue = unique(all_personal$`Common Name`[all_personal$Observer=="Susan Lewis"])
  ),
  label_geom = "text",
  label_color="white",
  label_alpha = 0.9)
})

output$unique_birds <- DT::renderDT({ 
  Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Abby Lewis"])
  Abby_text <- HTML(paste(Abby[!Abby%in%Other], collapse = "<br>"))
  
  Sue = unique(all_personal$`Common Name`[all_personal$Observer=="Susan Lewis"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Susan Lewis"])
  Sue_text <- HTML(paste(Sue[!Sue%in%Other], collapse = "<br>"))
  
  Bjorn = unique(all_personal$`Common Name`[all_personal$Observer=="Bjorn Larson"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Bjorn Larson"])
  Bjorn_text <- HTML(paste(Bjorn[!Bjorn%in%Other], collapse = "<br>"))
  
  Eric = unique(all_personal$`Common Name`[all_personal$Observer=="Eric Larson"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Eric Larson"])
  Eric_text <- HTML(paste(Eric[!Eric%in%Other], collapse = "<br>"))
  
  comb <- data.frame(Abby = Abby_text, 
                     Bjorn = Bjorn_text, 
                     Sue = Sue_text, 
                     Eric = Eric_text)
  DT::datatable(comb,
                escape = FALSE,
                rownames = FALSE,
                options = list(
                  dom = "t",
                  paging = FALSE,
                  searching = FALSE,
                  ordering = FALSE
                ),
                class = "compact"
  ) %>%
    DT::formatStyle(
      columns = names(comb),
      verticalAlign = "top"
    )
})

#Choose what to plot
output$selected_comp <- renderUI({
  if (input$to_plot == "Species") {
    plotlyOutput("plot_comp")
  } else if (input$to_plot == "Individuals") {
    plotlyOutput("plot_comp_bird")
  } else if (input$to_plot == "Checklists") {
    plotlyOutput("plot_comp_check")
  }
})

output$selected_comb <- renderUI({
  if(input$to_plot == "Species") {
    if(input$contrib == "Yes") {
      plotlyOutput("plot_comb_split")
    }else{plotlyOutput("plot_comb")}
  }else if (input$to_plot == "Individuals") {
    plotlyOutput("plot_comb_bird")
  }else if (input$to_plot == "Checklists") {
    plotlyOutput("plot_comb_check")
  }
})
```
