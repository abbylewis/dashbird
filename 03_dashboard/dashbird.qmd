---
title: "DashBIRD"
title-block-banner: true
format: 
  html:
    page-layout: full
server: shiny
---

<style>
.quarto-title-banner {
  background-image: url("images/background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  
  /* Make it taller */
  min-height: 200px;
  
  color: white; 
}

.quarto-title-banner .title {
  margin-top: 100px; /* Adjust the value as needed */
}
.quarto-title-banner .subtitle, 
.quarto-title-banner .author {
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6); /* make text readable */
}

</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

library(tidyverse)
library(plotly)
library(shiny)
library(leaflet)
library(htmltools)
library(colorspace)

# For plots
base_cols <- c(
  "Abby Lewis"   = "#60AB9A",
  "Bjorn Larson" = "#18476E",
  "Eric Larson"  = "#F5B905",
  "Susan Lewis"  = "#A355C7"
)

year_cols <- c(
  "2024" = "#4ECDC4",
  "2025" = "#29363D",
  "2026" = "#E54B4B"
)
```

::: {.row}

::: {.panel-tabset}

## Collaborative

```{r}
#| panel: sidebar

uiOutput('totals')
h4("Plot Specifications")
radioButtons(inputId = "to_plot_comb",
             label = "To plot:",
             choices = c("Species",
                         "Individuals",
                         "Checklists"))
br()
radioButtons(inputId = "contrib",
             label = "Show individual contributions?",
             choices = c("No",
                         "Yes"))
```

```{r}
#| panel: fill
uiOutput('selected_comb', height = 420)
```

## Competitive

```{r}
#| panel: sidebar

uiOutput('leaderboard')
h4("Plot Specifications")
radioButtons(inputId = "to_plot_comp",
             label = "To plot:",
             choices = c("Species",
                         "Individuals",
                         "Checklists"))
```

```{r}
#| panel: fill
uiOutput('selected_comp', height = 420)
```

## Venn

```{r}
#| panel: fill
plotOutput('venn', height = 420)
h3("Unique birds")
DT::dataTableOutput("unique_birds")
```

## Map

```{r}
#| panel: fill

leafletOutput("map") 
```


:::

:::

```{r}
#| context: server

everything <- read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Abby_allData.csv", show_col_types = F) %>%
  mutate(Observer = "Abby Lewis") %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Bjorn_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Bjorn Larson"))  %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Eric_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Eric Larson"))  %>%
  bind_rows(read_csv("https://raw.githubusercontent.com/abbylewis/dashbird/refs/heads/main/02_extracted_data/Sue_allData.csv", show_col_types = F) %>%
              mutate(Observer = "Susan Lewis")) %>%
  mutate(Date = as.Date(Date, format = "%d %b %Y")) %>%
  arrange(Date) %>%
  mutate(check_ID = paste(Date, Time, Latitude, Longitude),
         `Common Name` = sub(" \\(.+\\)", "", `Common Name`)) %>%
  filter(!grepl("sp.", `Common Name`),
         !grepl("/", `Common Name`))

#Species
all <- everything %>%
  select(`Common Name`, Date, Observer, Time) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  arrange(Date) 

all_personal <- all %>%
  group_by(year, Observer) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number(),
         year = year(Date)) 

all_personal_filled <- all %>%
  group_by(year, Observer) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number()) %>%
  group_by(Date, Observer) %>%
  filter(cum_sum == max(cum_sum)) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    )) %>%
  mutate(year = year(Date)) %>%
  tibble() %>%
  group_by(Observer, year) %>%
  arrange(Date) %>%
  fill(c(cum_sum))

all_collaborative <- all %>%
  select(-Observer) %>%
  group_by(year) %>%
  filter(!duplicated(`Common Name`)) %>%
  mutate(cum_sum = row_number())  %>%
  left_join(all_personal %>% select(-cum_sum, -Time) %>%
              filter(!is.na(`Common Name`))) %>%
  group_by(Date, `Common Name`) %>%
  mutate(credit = 1/length(unique(Observer))) %>%
  group_by(Observer, year) %>%
  arrange(Date) %>%
  mutate(cum_sum = cumsum(credit)) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    )) %>%
  mutate(year = year(Date)) %>%
  arrange(Date) %>%
  fill(c(cum_sum)) %>%
  group_by(Observer) 

#Individuals
all_birds <- everything %>%
  group_by(check_ID) %>%
  filter(!Count == "X") %>%
  mutate(number_of_us = length(unique(Observer)),
         Count = as.numeric(Count)/number_of_us,
         Date = as.Date(Date, format = "%d %b %Y")) %>%
  ungroup() %>%
  arrange(Date) %>%
  select(Count, Date, Observer) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(as.numeric(Count))) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    ),
    fill = list(Count = 0)
  ) %>%
  mutate(year = year(Date)) %>%
  arrange(Date)

all_personal_birds <- all_birds %>%
  group_by(year, Observer) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_birds <- all_birds %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Checklists
all_check <- everything %>%
  select(check_ID, Observer, Date) %>%
  distinct() %>%
  group_by(check_ID) %>%
  mutate(number_of_us = length(unique(Observer)),
         Date = as.Date(Date, format = "%d %b %Y"),
         credit = 1/number_of_us) %>%
  arrange(Date) %>%
  select(check_ID, Date, Observer, credit) %>%
  mutate(year = year(Date)) %>%
  filter(!year == 2023) %>%
  group_by(year, Date, Observer) %>%
  summarize(Count = sum(credit)) %>%
  group_by(Observer) %>%
  complete(
    Date = seq.Date(
      from = as.Date("2024-01-01"),
      to   = Sys.Date(),
      by   = "day"
    ),
    fill = list(Count = 0)
  ) %>%
  mutate(year = year(Date))

all_personal_check <- all_check %>%
  group_by(year, Observer) %>%
  arrange(year, Observer, Date) %>%
  mutate(cum_sum = cumsum(Count))

all_collaborative_check <- all_check %>%
  group_by(year, Date) %>%
  summarize(Count = sum(Count)) %>%
  group_by(year) %>%
  mutate(cum_sum = cumsum(Count))

#Locations

to_map <- everything %>%
  select(Location, Latitude, Longitude, check_ID, Date, Observer)%>%
  distinct()%>%
  group_by(Location, Latitude, Longitude, Observer)%>%
  summarize(n = n())%>%
  group_by(Location, Latitude, Longitude)%>%
  arrange(desc(n))%>%
  summarise(
    label_html = htmltools::HTML(paste0(
      "<b>", first(Location), "</b>", "<br/>",
      paste0(Observer, ": ", n, collapse = "<br/>")
    )),
    Observers = paste(Observer, collapse = ", "),
    Visits = paste(n, collapse = ", "),
    Tot_visits = 4*(sum(n)^(1/3)))

# Weighted circular mean for hue (degrees)
circ_mean_deg <- function(h, w) {
  rad <- h * pi / 180
  x <- sum(w * cos(rad), na.rm = TRUE)
  y <- sum(w * sin(rad), na.rm = TRUE)
  (atan2(y, x) * 180 / pi) %% 360
}

# Mix any number of hex colors with weights in polarLUV (HCL)
mix_hex_hcl_weighted <- function(hex_vec, w = NULL, fallback = "#808080") {
  hex_vec <- unique(na.omit(hex_vec))
  if (length(hex_vec) == 0) return(fallback)
  if (length(hex_vec) == 1) return(hex_vec)

  if (is.null(w)) w <- rep(1, length(hex_vec))
  w <- suppressWarnings(as.numeric(w))
  if (length(w) != length(hex_vec) || any(!is.finite(w))) w <- rep(1, length(hex_vec))
  w <- pmax(w, 0)
  if (sum(w) == 0) w <- rep(1, length(hex_vec))

  # Convert to polarLUV (HCL)
  hcl <- as(hex2RGB(hex_vec), "polarLUV")
  df <- as.data.frame(coords(hcl))  # columns: L, C, H

  # Hue may be NA when chroma ~0; weight hue by chroma to avoid nonsense
  w_h <- w * pmax(df$C, 1e-6)

  L_bar <- sum(w * df$L, na.rm = TRUE) / sum(w)
  C_bar <- sum(w * df$C, na.rm = TRUE) / sum(w)
  H_bar <- circ_mean_deg(df$H, w_h)

  hex(polarLUV(L = L_bar, C = C_bar, H = H_bar))
}

mix_from_topcols <- function(top_obs_str, top_visits_str, base_cols, fallback = "#808080") {
  obs <- strsplit(as.character(top_obs_str), "\\s*,\\s*")[[1]]
  obs <- obs[nzchar(obs)]
  obs <- obs[obs %in% names(base_cols)]
  if (length(obs) == 0) return(fallback)
  if (length(obs) == 1) return(unname(base_cols[obs]))

  w <- strsplit(as.character(top_visits_str), "\\s*,\\s*")[[1]]
  w <- suppressWarnings(as.numeric(w))
  w <- w[seq_len(min(length(w), length(obs)))]

  cols <- unname(base_cols[obs])
  mix_hex_hcl_weighted(cols, w = w, fallback = fallback)
}

to_map$marker_col <- mapply(
  mix_from_topcols,
  to_map$Observers,
  to_map$Visits,
  MoreArgs = list(base_cols = base_cols),
  USE.NAMES = FALSE
)

#Code for plots
output$plot_comb_split <- renderPlotly({
  comb_plot_data <- all_collaborative %>%
    mutate(yday = yday(Date)) %>%
    group_by(Observer, year) %>%
    arrange(Observer, year, yday) %>%
    mutate(Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year),
           Date_stand = as.Date("2024-01-01")+days(yday-1)) 
  
  comb_plot <- comb_plot_data %>%
    ggplot(aes(x = Date_stand, y = cum_sum, fill = Observer))+
    geom_area()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_fill_manual(values = base_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot, tooltip = c("fill"))
})

output$plot_comb <- renderPlotly({
  comb_plot <- all_collaborative %>%
    group_by(Date, year) %>%
    summarize(credit = sum(credit, na.rm = T)) %>%
    group_by(year) %>%
    mutate(cum_sum = cumsum(credit)) %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = year_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_bird <- renderPlotly({
  comb_plot <- all_collaborative_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = year_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comb_check <- renderPlotly({
  comb_plot <- all_collaborative_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = year))+
    geom_line()+
    egg::theme_article()+
    #facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = year_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp <- renderPlotly({
  comb_plot <- all_personal_filled %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of species")+
    scale_color_manual(values = base_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_bird <- renderPlotly({
  comb_plot <- all_personal_birds %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of individuals")+
    scale_color_manual(values = base_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$plot_comp_check <- renderPlotly({
  comb_plot <- all_personal_check %>%
    mutate(yday = yday(Date),
           Date_stand = as.Date("2024-01-01")+days(yday-1),
           year = as.factor(year)) %>%
    ggplot(aes(x = Date_stand, y = cum_sum, color = Observer))+
    geom_line()+
    egg::theme_article()+
    facet_wrap(~year, scales = "free_x")+
    ylab("Number of checklists")+
    scale_color_manual(values = base_cols)+
    scale_x_date(date_labels = "%b", 
                 expand = c(0,0))+
    theme(panel.grid.major = element_line(color = "grey95"),
          axis.title.x = element_blank(),
          panel.border = element_rect(color = "grey20"))
  
  plotly::ggplotly(comb_plot)
})

output$venn <- renderPlot({
  ggVennDiagram::ggVennDiagram(x = list(
    Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"]),
    Bjorn = unique(all_personal$`Common Name`[all_personal$Observer=="Bjorn Larson"]),
    Eric = unique(all_personal$`Common Name`[all_personal$Observer=="Eric Larson"]),
    Sue = unique(all_personal$`Common Name`[all_personal$Observer=="Susan Lewis"])
  ),
  label_geom = "text",
  label_color="white",
  label_alpha = 0.9)
})

output$unique_birds <- DT::renderDT({ 
  Abby = unique(all_personal$`Common Name`[all_personal$Observer=="Abby Lewis"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Abby Lewis"])
  Abby_text <- HTML(paste(Abby[!Abby%in%Other], collapse = "<br>"))
  
  Sue = unique(all_personal$`Common Name`[all_personal$Observer=="Susan Lewis"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Susan Lewis"])
  Sue_text <- HTML(paste(Sue[!Sue%in%Other], collapse = "<br>"))
  
  Bjorn = unique(all_personal$`Common Name`[all_personal$Observer=="Bjorn Larson"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Bjorn Larson"])
  Bjorn_text <- HTML(paste(Bjorn[!Bjorn%in%Other], collapse = "<br>"))
  
  Eric = unique(all_personal$`Common Name`[all_personal$Observer=="Eric Larson"])
  Other = unique(all_personal$`Common Name`[!all_personal$Observer=="Eric Larson"])
  Eric_text <- HTML(paste(Eric[!Eric%in%Other], collapse = "<br>"))
  
  comb <- data.frame(Abby = Abby_text, 
                     Bjorn = Bjorn_text, 
                     Sue = Sue_text, 
                     Eric = Eric_text)
  DT::datatable(comb,
                escape = FALSE,
                rownames = FALSE,
                options = list(
                  dom = "t",
                  paging = FALSE,
                  searching = FALSE,
                  ordering = FALSE
                ),
                class = "compact"
  ) %>%
    DT::formatStyle(
      columns = names(comb),
      verticalAlign = "top"
    )
})

#Choose what to plot
output$selected_comp <- renderUI({
  if (input$to_plot_comp == "Species") {
    plotlyOutput("plot_comp")
  } else if (input$to_plot_comp == "Individuals") {
    plotlyOutput("plot_comp_bird")
  } else if (input$to_plot_comp == "Checklists") {
    plotlyOutput("plot_comp_check")
  }
})

output$selected_comb <- renderUI({
  if(input$to_plot_comb == "Species") {
    if(input$contrib == "Yes") {
      plotlyOutput("plot_comb_split")
    }else{plotlyOutput("plot_comb")}
  }else if (input$to_plot_comb == "Individuals") {
    plotlyOutput("plot_comb_bird")
  }else if (input$to_plot_comb == "Checklists") {
    plotlyOutput("plot_comb_check")
  }
})

# Text outputs
output$totals <- renderText({
  year <- year(Sys.Date())
  species <- length(unique(all_personal$`Common Name`[all_personal$year == year]))
  individuals <- sum(all_collaborative_birds$Count[all_collaborative_birds$year == year])
  checklists <- sum(all_collaborative_check$Count[all_collaborative_check$year == year])
  output <- paste("<h4>",year," totals</h4><ul><li><b>",
                  species,"</b> species<br></li><li><b>",
                  individuals,"</b> individuals</li><li><b>",
                  checklists,"</b> checklists</li></ul>"
                  )
})

output$leaderboard <- renderText({
  year <- year(Sys.Date())
  abby <- length(unique(all_personal$`Common Name`[
    all_personal$year == year & all_personal$Observer == "Abby Lewis"]))
  bjorn <- length(unique(all_personal$`Common Name`[
    all_personal$year == year & all_personal$Observer == "Bjorn Larson"]))
  sue <- length(unique(all_personal$`Common Name`[
    all_personal$year == year & all_personal$Observer == "Susan Lewis"]))
  eric <- length(unique(all_personal$`Common Name`[
    all_personal$year == year & all_personal$Observer == "Eric Larson"]))
  output <- paste("<h4>",year," species</h4><ul><li>Abby: <b>",
                  abby,"</b> species<br></li><li>Bjorn: <b>",
                  bjorn,"</b> species</li><li>Sue: <b>",
                  sue,"</b> species</li><li>Eric: <b>",
                  eric, "</b> species</li></ul>"
                  )
})

pal <- colorFactor(base_cols, domain = c("Abby Lewis", "Bjorn Larson", "Eric Larson", "Susan Lewis"))

output$map <- renderLeaflet({ 
  leaflet(to_map) %>%
    addTiles() %>%
    addCircleMarkers(
      lat = ~Latitude, 
      lng = ~Longitude, 
      radius = ~Tot_visits,
      color = ~marker_col,
      fillColor = ~marker_col, 
      fillOpacity = 0.5,
      
      label = ~label_html,
      labelOptions = labelOptions(
        direction = "auto",
        opacity = 0.9,
        textsize = "13px",
        style = list(
          "background-color" = "white", 
          "padding" = "6px")
      )
    )

})
```
